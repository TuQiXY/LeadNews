### 项目术语定义
- 项目：泛指黑马头条整个项目或某一项目模块
- 工程：泛指黑马头条某一项目的源码工程
- 用户：泛指黑马头条APP用户端用户
- 自媒体人：泛指通过黑马自媒体系统发送文章的用户
- 管理员：泛指黑马头条管理系统的使用用户
- App：泛指黑马头条APP
- WeMedia：泛指黑马头条自媒体系统
- Admin：泛指黑马头条管理系统

### 模块设计
- common：一些通用配置
- fileup-start：文件上传接口
- feign-api：feign对外接口
- model：实体类
- util：通用的工具
- gateway：管理网管工程
- service：微服务实现模块

### APP主要功能大纲
- 频道栏：用户可以通过此功能添加自己感兴趣的频道，在添加标签时，系统可依据用户喜好进行推荐
- 文章列表：需要显示文章标题、文章图片、评论数等信息，且需要监控文章是否在APP端展现的行为
- 搜索文章：联想用户想搜索的内容，并记录用户的历史搜索信息
- 个人中心：用户可以在其个人中心查看收藏、关注的人、以及系统设置等功能
- 查看文章：用户点击文章进入查看文章页面，在此页面上可进行点赞、评论、不喜欢、分享等操作；除此之外还需要收集用户查看文章的时间，是否看我等行为信息
- 实名认证：用户可以进行身份证认证和实名认证，实名认证之后即可成为自媒体人，在平台上发布文章
- 注册登录：登录时，验证内容为手机号登录/注册，通过手机号验证码进行登录/注册，首次登录用户自动注册账号。
- 用户管理：系统后台用来维护用户信息，可以对用户进行增删改查操作，对于违规用户可以进行冻结操
- 用户审核：管理员审核用户信息页面，用户审核分为身份审核和实名审核，身份审核是对用户的身份信息进行审核，包括但不限于工作信息、资质信息、经历信息等；实名认证是对用户实名身份进行认证
- 内容管理：管理员查询现有文章，并对文章进行新增、删除、修改、置顶等操作
- 内容审核：管理员审核自媒体人发布的内容，包括但不限于文章文字、图片、敏感信息等
- 频道管理：管理频道分类界面，可以新增频道，查看频道，新增或修改频道关联的标签
- 权限管理：超级管理员对后台管理员账号进行新增或删除角色操作

### 技术栈：Springboot springmvc spring mybatis，mybatisplus，redis
- 使用持久层框架mybatis
- 接口测试：postman，swagger，knife4j
- 利用freemarker调用Configuration接口生成文章模板
- 运用minio进行图片，文章对象存储
  - 优点：高性能可达55GB/s读35GB/s写
  - 可扩容：不同的minio集群可以组成联邦，形成一个全局的命名空间，跨越多个数据中心
  - 基于golang实现，提供java python go等SDK
  - 页面简单 api丰富
- 运用redis实现延迟任务发布：将岩石任务添加到数据库中，利用redis中list，zset两种数据类型
- 利用分布式锁解决集群下方法抢占执行
- 利用kafka完成app端与自媒体端异步消息通知文章上下架，利用zookeeper保存kafka节点数据
- 文章审核成功后保存数据库并上传至es库中，搜索时在elasticsearch中进行高速检索
- 利用mongodb存储用户搜索历史，并根据用户输入的关键词展示联想词
- 利用redis存储热点文章数据，利用xxl-job分布式调度平台定时计算文章热点数据
- 利用kafka流事实聚合消息实现热点数据实时计算
- 利用jenkins进行项目持续集成




### 用户端功能实现：
#### 全局过滤实现jwt校验：
- 用户点击登录输入用户名和密码校验成功后返回jwt（基于当前用户id生成）：登陆后可以查看可以操作
- 用户点击不登陆先看看生成jwt返回（基于默认值0生成）：游客只有查看权限
#### 流程：
- 1. 用户进入网关开始登陆，网关过滤器进行判断，如果用户请求登录则路由到后台微服务进行登录
- 2. 用户登录成功，后台管理微服务签发jwt token信息返回给用户，用户可以携带token访问其他微服务
- 3. 如果用户的请求不是登录，则校验用户是否携带jwt，若携带，则允许访问，反之返回404
#### 频道展示：
- 在默认频道展示10条文章信息，可以切换频道查看不同种类文章
- 下拉加载最新文章，以发布时间最大为依据
- 上拉加载更多，以发布时间最小为依据
#### 查询文章优化
1. 询问是否为主页，是则在redis中加载缓存信息
2. 不是则在数据库中查询数据

### 自媒体端功能实现：
#### 发布文章：
1. 前端提交发布或保存为草稿
2. 后台判断请求中是否包含文章id
3. 若包含则为修改：删除该文章与素材的关系，执行修改操作，关联内容图片与素材的关系，关联封面图片与素材的关系
4. 若不包含则为新增：执行新增文章操作，关联内容图片与素材的关系，关联封面图片与素材的关系
#### 延迟任务发布
1. 添加延时任务到数据库
2. 当执行时间等于当前时间时存入redis的list队列缓存
3. 当执行时间小于未来五分钟时，将任务存入zset队列中
4. zset队列中的任务向list队列中定时刷新
#### 利用分布式锁解决集群下方法抢占执行
#### kafka完成app端与自媒体端异步消息通知文章上下架
1. 文章审核成功后使用kafka发送消息从生产者（文章微服务）
2. 搜索微服务接收消息，添加数据到索引库，消费者（搜索微服务）


### 热点文章定时计算
1. 利用xxl-job每天凌晨定时查询前五天文章
2. 计算文章分值
3. 检索出每个频道的文章
4. 取出30条分值较高的文章存入redis
5. 设置推荐数据，取30条最高热度文章存入redis

### 热点文章实时计算
1. 将用户行为发送给kafka
2. 利用kafkaStream进行流式聚合处理，10s一个时间窗口
3. 重新计算文章分值并发送消息
4. 更新文章分值，并更新redis缓存中的文章数据
5. 比较分值
6. 更新排序/替换排序






<h3>整理过程中遇到的疑问</h3>

### 1.解决md5加密每次数据一样不安全的问题
- 方法：加盐 手动加密，随机生成字符串（盐） 用户密码＋字符串以md5加密方式存储在数据库中
### 2.报redis配置找不到，原因是找不到redis服务
- 解决方案一：在heima-leadnews-user服务中的bootstrap.yml文件中添加配置忽略，如下：
- spring:
  #忽略掉配置类
  autoconfigure:
  exclude: org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration
- 注意：后期如果heima-leadnews-user服务需要依赖于redis，则需要把上述配置注释或删除
- 解决方案二：在heima-leadnews-user服务中的bootstrap.yml文件中添加redis配置（需要安装redis服务）
- spring:
  redis:
  host: localhost
  port: 6379
  password: leadnews

### 3.出现三次java程序包不存在
- 试了很多种方法重新编译maven，在新增模块时依旧出现此种情况，最后卸载idea，换了个版本，2023.02-2022.03版本

### 4.上传图片时用户id获取时报空指针异常
- wmTokenFilter没有设置用户信息到threadlocal中，没有将用户信息保存到当前线程中。

### 5.发布文章时空指针异常
- 打断点后发现dto属性都为空，，然后发现Beautils抛出很多异常到controller，然后去检查BeanUtils发现导错包了

### 6.为什么任务需要存储在数据库中？
- 延迟任务是一个通用的服务，任何需要延迟得任务都可以调用该服务，需要考虑数据持久化的问题，存储数据库中是一种数据安全的考虑。

### 7.为什么redis中使用两种数据类型，list和zset？
- 效率问题，算法的时间复杂度
- list用于存储当前进行的任务队列，zset存储规定时间内的延迟任务
- 循环的从延迟队列中拉取任务

### 8.在添加zset数据的时候，为什么不需要预加载？
- 任务模块是一个通用的模块，项目中任何需要延迟队列的地方，都可以调用这个接口，要考虑到数据量 的问题，如果数据量特别大，为了防止阻塞，只需要把未来几分钟要执行的数据存入缓存即可。

### 9.minio上传文件失败
- 确保虚拟机时间和系统本地时间一致
